name: Build & Test - J2Commerce Privacy

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'J2Commerce/plg_privacy_j2commerce/**'

jobs:
  build-01:
    name: 01 - Build Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get update && sudo apt-get install -y rsync zip
      - working-directory: J2Commerce/plg_privacy_j2commerce
        run: |
          chmod +x build.sh
          ./build.sh
      - uses: actions/upload-artifact@v6
        with:
          name: extension-package
          path: J2Commerce/plg_privacy_j2commerce/*.zip

  test-02-installation:
    name: 02 - Test Installation
    runs-on: ubuntu-latest
    needs: build-01
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with: {name: extension-package, path: package}
      - run: cp package/*.zip J2Commerce/plg_privacy_j2commerce/tests/extension.zip
      - working-directory: J2Commerce/plg_privacy_j2commerce/tests
        run: |
          docker compose up -d
          sleep 120
          chmod +x run-tests.sh
          ./run-tests.sh installation
      - if: always()
        uses: actions/upload-artifact@v6
        with:
          name: installation-logs
          path: J2Commerce/plg_privacy_j2commerce/tests/test-results/*.txt
          if-no-files-found: warn
      - if: always()
        working-directory: J2Commerce/plg_privacy_j2commerce/tests
        run: docker compose down -v

  test-03-uninstall:
    name: 03 - Test Uninstall
    runs-on: ubuntu-latest
    needs: test-02-installation
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with: {name: extension-package, path: package}
      - run: cp package/*.zip J2Commerce/plg_privacy_j2commerce/tests/extension.zip
      - working-directory: J2Commerce/plg_privacy_j2commerce/tests
        run: |
          docker compose up -d
          sleep 120
          chmod +x run-tests.sh
          ./run-tests.sh installation
      - if: always()
        uses: actions/upload-artifact@v6
        with:
          name: uninstall-logs
          path: J2Commerce/plg_privacy_j2commerce/tests/test-results/*.txt
          if-no-files-found: warn
      - if: always()
        working-directory: J2Commerce/plg_privacy_j2commerce/tests
        run: docker compose down -v
