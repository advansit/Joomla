name: Build & Test - J2Commerce AcyMailing

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'J2Commerce/plg_j2commerce_acymailing/**'

jobs:
  build-01:
    name: 01 - Build Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get update && sudo apt-get install -y rsync zip
      - working-directory: J2Commerce/plg_j2commerce_acymailing
        run: |
          chmod +x build.sh
          ./build.sh
      - uses: actions/upload-artifact@v6
        with:
          name: extension-package
          path: J2Commerce/plg_j2commerce_acymailing/*.zip

  test-02-installation:
    name: 02 - Test Installation
    runs-on: ubuntu-latest
    needs: build-01
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with: {name: extension-package, path: package}
      - run: cp package/*.zip J2Commerce/plg_j2commerce_acymailing/tests/extension.zip
      - working-directory: J2Commerce/plg_j2commerce_acymailing/tests
        run: |
          docker compose up -d
          sleep 120
          chmod +x run-tests.sh
          ./run-tests.sh installation || true
      - if: always()
        uses: actions/upload-artifact@v6
        with:
          name: installation-logs
          path: J2Commerce/plg_j2commerce_acymailing/tests/test-results/*.txt
          if-no-files-found: warn
      - if: always()
        working-directory: J2Commerce/plg_j2commerce_acymailing/tests
        run: docker compose down -v

  test-03-uninstall:
    name: 03 - Test Uninstall
    runs-on: ubuntu-latest
    needs: test-02-installation
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with: {name: extension-package, path: package}
      - run: cp package/*.zip J2Commerce/plg_j2commerce_acymailing/tests/extension.zip
      - working-directory: J2Commerce/plg_j2commerce_acymailing/tests
        run: |
          docker compose up -d
          sleep 120
          chmod +x run-tests.sh
          ./run-tests.sh uninstall || true
      - if: always()
        uses: actions/upload-artifact@v6
        with:
          name: uninstall-logs
          path: J2Commerce/plg_j2commerce_acymailing/tests/test-results/*.txt
          if-no-files-found: warn
      - if: always()
        working-directory: J2Commerce/plg_j2commerce_acymailing/tests
        run: docker compose down -v

  commit-logs:
    name: 04 - Commit Test Logs
    runs-on: ubuntu-latest
    needs: [test-02-installation, test-03-uninstall]
    if: always()
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}
      - uses: actions/download-artifact@v7
        with:
          pattern: '*-logs'
          path: downloaded-logs
          merge-multiple: true
      - name: Copy logs to repository
        run: |
          mkdir -p J2Commerce/plg_j2commerce_acymailing/tests/logs
          cp -f downloaded-logs/*.txt J2Commerce/plg_j2commerce_acymailing/tests/logs/ 2>/dev/null || echo "No logs to copy"
      - name: Commit and push logs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add J2Commerce/plg_j2commerce_acymailing/tests/logs/*.txt || true
          git diff --staged --quiet || git commit -m "Update test logs for AcyMailing plugin [skip ci]"
          git push || true
